module mathm
   ! Math routines for NJOY2016.
   use locale
   implicit none
   private

   !--Public routines
   public legndr,e1,gami,erfc

contains

   subroutine legndr(x,p,np)
   !--------------------------------------------------------------------
   ! Generate Legendre polynomials at x by recursion.
   ! Place p(subl) in p(l+1).
   !--------------------------------------------------------------------
   ! externals
   real(kr)::x
   real(kr)::p(*)
   integer::np
   ! internals
   integer::m1,i
   real(kr)::g,h

   p(1)=1
   p(2)=x
   if (np.lt.2) return
   m1=np-1
   do i=1,m1
      g=x*p(i+1)
      h=g-p(i)
      p(i+2)=h+g-h/(i+1)
   enddo
   return
   end subroutine legndr

   real(kr) function e1(x)
   !--------------------------------------------------------------------
   ! Compute the exponential integral e1(x).
   ! Taken from the SLATEC library fnlib de1.
   !--------------------------------------------------------------------
   use util ! provides error
   ! externals
   real(kr)::x
   ! internals
   real(kr)::eta,xx,xmax,xmaxt
   integer::ntae10,ntae11,ntae12,nte11,nte12,ntae13,ntae14
   real(kr),dimension(50)::ae10cs=(/&
     +.3284394579616699087873844201881e-1_kr,&
     -.1669920452031362851476184343387e-1_kr,&
     +.2845284724361346807424899853252e-3_kr,&
     -.7563944358516206489487866938533e-5_kr,&
     +.2798971289450859157504843180879e-6_kr,&
     -.1357901828534531069525563926255e-7_kr,&
     +.8343596202040469255856102904906e-9_kr,&
     -.6370971727640248438275242988532e-10_kr,&
     +.6007247608811861235760831561584e-11_kr,&
     -.7022876174679773590750626150088e-12_kr,&
     +.1018302673703687693096652346883e-12_kr,&
     -.1761812903430880040406309966422e-13_kr,&
     +.3250828614235360694244030353877e-14_kr,&
     -.5071770025505818678824872259044e-15_kr,&
     +.1665177387043294298172486084156e-16_kr,&
     +.3166753890797514400677003536555e-16_kr,&
     -.1588403763664141515133118343538e-16_kr,&
     +.4175513256138018833003034618484e-17_kr,&
     -.2892347749707141906710714478852e-18_kr,&
     -.2800625903396608103506340589669e-18_kr,&
     +.1322938639539270903707580023781e-18_kr,&
     -.1804447444177301627283887833557e-19_kr,&
     -.7905384086522616076291644817604e-20_kr,&
     +.4435711366369570103946235838027e-20_kr,&
     -.4264103994978120868865309206555e-21_kr,&
     -.3920101766937117541553713162048e-21_kr,&
     +.1527378051343994266343752326971e-21_kr,&
     +.1024849527049372339310308783117e-22_kr,&
     -.2134907874771433576262711405882e-22_kr,&
     +.3239139475160028267061694700366e-23_kr,&
     +.2142183762299889954762643168296e-23_kr,&
     -.8234609419601018414700348082312e-24_kr,&
     -.1524652829645809479613694401140e-24_kr,&
     +.1378208282460639134668480364325e-24_kr,&
     +.2131311202833947879523224999253e-26_kr,&
     -.2012649651526484121817466763127e-25_kr,&
     +.1995535662263358016106311782673e-26_kr,&
     +.2798995808984003464948686520319e-26_kr,&
     -.5534511845389626637640819277823e-27_kr,&
     -.3884995396159968861682544026146e-27_kr,&
     +.1121304434507359382850680354679e-27_kr,&
     +.5566568152423740948256563833514e-28_kr,&
     -.2045482929810499700448533938176e-28_kr,&
     -.8453813992712336233411457493674e-29_kr,&
     +.3565758433431291562816111116287e-29_kr,&
     +.1383653872125634705539949098871e-29_kr,&
     -.6062167864451372436584533764778e-30_kr,&
     -.2447198043989313267437655119189e-30_kr,&
     +.1006850640933998348011548180480e-30_kr,&
     +.4623685555014869015664341461674e-31_kr/)
   real(kr),dimension(60)::ae11cs=(/&
     +.20263150647078889499401236517381e+0_kr,&
     -.73655140991203130439536898728034e-1_kr,&
     +.63909349118361915862753283840020e-2_kr,&
     -.60797252705247911780653153363999e-3_kr,&
     -.73706498620176629330681411493484e-4_kr,&
     +.48732857449450183453464992488076e-4_kr,&
     -.23837064840448290766588489460235e-5_kr,&
     -.30518612628561521027027332246121e-5_kr,&
     +.17050331572564559009688032992907e-6_kr,&
     +.23834204527487747258601598136403e-6_kr,&
     +.10781772556163166562596872364020e-7_kr,&
     -.17955692847399102653642691446599e-7_kr,&
     -.41284072341950457727912394640436e-8_kr,&
     +.68622148588631968618346844526664e-9_kr,&
     +.53130183120506356147602009675961e-9_kr,&
     +.78796880261490694831305022893515e-10_kr,&
     -.26261762329356522290341675271232e-10_kr,&
     -.15483687636308261963125756294100e-10_kr,&
     -.25818962377261390492802405122591e-11_kr,&
     +.59542879191591072658903529959352e-12_kr,&
     +.46451400387681525833784919321405e-12_kr,&
     +.11557855023255861496288006203731e-12_kr,&
     -.10475236870835799012317547189670e-14_kr,&
     -.11896653502709004368104489260929e-13_kr,&
     -.47749077490261778752643019349950e-14_kr,&
     -.81077649615772777976249734754135e-15_kr,&
     +.13435569250031554199376987998178e-15_kr,&
     +.14134530022913106260248873881287e-15_kr,&
     +.49451592573953173115520663232883e-16_kr,&
     +.79884048480080665648858587399367e-17_kr,&
     -.14008632188089809829248711935393e-17_kr,&
     -.14814246958417372107722804001680e-17_kr,&
     -.55826173646025601904010693937113e-18_kr,&
     -.11442074542191647264783072544598e-18_kr,&
     +.25371823879566853500524018479923e-20_kr,&
     +.13205328154805359813278863389097e-19_kr,&
     +.62930261081586809166287426789485e-20_kr,&
     +.17688270424882713734999261332548e-20_kr,&
     +.23266187985146045209674296887432e-21_kr,&
     -.67803060811125233043773831844113e-22_kr,&
     -.59440876959676373802874150531891e-22_kr,&
     -.23618214531184415968532592503466e-22_kr,&
     -.60214499724601478214168478744576e-23_kr,&
     -.65517906474348299071370444144639e-24_kr,&
     +.29388755297497724587042038699349e-24_kr,&
     +.22601606200642115173215728758510e-24_kr,&
     +.89534369245958628745091206873087e-25_kr,&
     +.24015923471098457555772067457706e-25_kr,&
     +.34118376888907172955666423043413e-26_kr,&
     -.71617071694630342052355013345279e-27_kr,&
     -.75620390659281725157928651980799e-27_kr,&
     -.33774612157467324637952920780800e-27_kr,&
     -.10479325703300941711526430332245e-27_kr,&
     -.21654550252170342240854880201386e-28_kr,&
     -.75297125745288269994689298432000e-30_kr,&
     +.19103179392798935768638084000426e-29_kr,&
     +.11492104966530338547790728833706e-29_kr,&
     +.43896970582661751514410359193600e-30_kr,&
     +.12320883239205686471647157725866e-30_kr,&
     +.22220174457553175317538581162666e-31_kr/)
   real(kr),dimension(41)::ae12cs=(/&
     +.63629589796747038767129887806803e+0_kr,&
     -.13081168675067634385812671121135e+0_kr,&
     -.84367410213053930014487662129752e-2_kr,&
     +.26568491531006685413029428068906e-2_kr,&
     +.32822721781658133778792170142517e-3_kr,&
     -.23783447771430248269579807851050e-4_kr,&
     -.11439804308100055514447076797047e-4_kr,&
     -.14405943433238338455239717699323e-5_kr,&
     +.52415956651148829963772818061664e-8_kr,&
     +.38407306407844323480979203059716e-7_kr,&
     +.85880244860267195879660515759344e-8_kr,&
     +.10219226625855003286339969553911e-8_kr,&
     +.21749132323289724542821339805992e-10_kr,&
     -.22090238142623144809523503811741e-10_kr,&
     -.63457533544928753294383622208801e-11_kr,&
     -.10837746566857661115340539732919e-11_kr,&
     -.11909822872222586730262200440277e-12_kr,&
     -.28438682389265590299508766008661e-14_kr,&
     +.25080327026686769668587195487546e-14_kr,&
     +.78729641528559842431597726421265e-15_kr,&
     +.15475066347785217148484334637329e-15_kr,&
     +.22575322831665075055272608197290e-16_kr,&
     +.22233352867266608760281380836693e-17_kr,&
     +.16967819563544153513464194662399e-19_kr,&
     -.57608316255947682105310087304533e-19_kr,&
     -.17591235774646878055625369408853e-19_kr,&
     -.36286056375103174394755328682666e-20_kr,&
     -.59235569797328991652558143488000e-21_kr,&
     -.76030380926310191114429136895999e-22_kr,&
     -.62547843521711763842641428479999e-23_kr,&
     +.25483360759307648606037606400000e-24_kr,&
     +.25598615731739857020168874666666e-24_kr,&
     +.71376239357899318800207052800000e-25_kr,&
     +.14703759939567568181578956800000e-25_kr,&
     +.25105524765386733555198634666666e-26_kr,&
     +.35886666387790890886583637333333e-27_kr,&
     +.39886035156771301763317759999999e-28_kr,&
     +.21763676947356220478805333333333e-29_kr,&
     -.46146998487618942367607466666666e-30_kr,&
     -.20713517877481987707153066666666e-30_kr,&
     -.51890378563534371596970666666666e-31_kr/)
   real(kr),dimension(29)::e11cs=(/&
     -.16113461655571494025720663927566180e+2_kr,&
     +.77940727787426802769272245891741497e+1_kr,&
     -.19554058188631419507127283812814491e+1_kr,&
     +.37337293866277945611517190865690209e+0_kr,&
     -.56925031910929019385263892220051166e-1_kr,&
     +.72110777696600918537847724812635813e-2_kr,&
     -.78104901449841593997715184089064148e-3_kr,&
     +.73880933562621681878974881366177858e-4_kr,&
     -.62028618758082045134358133607909712e-5_kr,&
     +.46816002303176735524405823868362657e-6_kr,&
     -.32092888533298649524072553027228719e-7_kr,&
     +.20151997487404533394826262213019548e-8_kr,&
     -.11673686816697793105356271695015419e-9_kr,&
     +.62762706672039943397788748379615573e-11_kr,&
     -.31481541672275441045246781802393600e-12_kr,&
     +.14799041744493474210894472251733333e-13_kr,&
     -.65457091583979673774263401588053333e-15_kr,&
     +.27336872223137291142508012748799999e-16_kr,&
     -.10813524349754406876721727624533333e-17_kr,&
     +.40628328040434303295300348586666666e-19_kr,&
     -.14535539358960455858914372266666666e-20_kr,&
     +.49632746181648636830198442666666666e-22_kr,&
     -.16208612696636044604866560000000000e-23_kr,&
     +.50721448038607422226431999999999999e-25_kr,&
     -.15235811133372207813973333333333333e-26_kr,&
     +.44001511256103618696533333333333333e-28_kr,&
     -.12236141945416231594666666666666666e-29_kr,&
     +.32809216661066001066666666666666666e-31_kr,&
     -.84933452268306432000000000000000000e-33_kr/)
   real(kr),dimension(25)::e12cs=(/&
     -.3739021479220279511668698204827e-1_kr,&
     +.4272398606220957726049179176528e-1_kr,&
     -.130318207984970054415392055219726e+0_kr,&
     +.144191240246988907341095893982137e-1_kr,&
     -.134617078051068022116121527983553e-2_kr,&
     +.107310292530637799976115850970073e-3_kr,&
     -.742999951611943649610283062223163e-5_kr,&
     +.453773256907537139386383211511827e-6_kr,&
     -.247641721139060131846547423802912e-7_kr,&
     +.122076581374590953700228167846102e-8_kr,&
     -.548514148064092393821357398028261e-10_kr,&
     +.226362142130078799293688162377002e-11_kr,&
     -.863589727169800979404172916282240e-13_kr,&
     +.306291553669332997581032894881279e-14_kr,&
     -.101485718855944147557128906734933e-15_kr,&
     +.315482174034069877546855328426666e-17_kr,&
     -.923604240769240954484015923200000e-19_kr,&
     +.255504267970814002440435029333333e-20_kr,&
     -.669912805684566847217882453333333e-22_kr,&
     +.166925405435387319431987199999999e-23_kr,&
     -.396254925184379641856000000000000e-25_kr,&
     +.898135896598511332010666666666666e-27_kr,&
     -.194763366993016433322666666666666e-28_kr,&
     +.404836019024630033066666666666666e-30_kr,&
     -.807981567699845120000000000000000e-32_kr/)
   real(kr),dimension(50)::ae13cs=(/&
     -.60577324664060345999319382737747e+0_kr,&
     -.11253524348366090030649768852718e+0_kr,&
     +.13432266247902779492487859329414e-1_kr,&
     -.19268451873811457249246838991303e-2_kr,&
     +.30911833772060318335586737475368e-3_kr,&
     -.53564132129618418776393559795147e-4_kr,&
     +.98278128802474923952491882717237e-5_kr,&
     -.18853689849165182826902891938910e-5_kr,&
     +.37494319356894735406964042190531e-6_kr,&
     -.76823455870552639273733465680556e-7_kr,&
     +.16143270567198777552956300060868e-7_kr,&
     -.34668022114907354566309060226027e-8_kr,&
     +.75875420919036277572889747054114e-9_kr,&
     -.16886433329881412573514526636703e-9_kr,&
     +.38145706749552265682804250927272e-10_kr,&
     -.87330266324446292706851718272334e-11_kr,&
     +.20236728645867960961794311064330e-11_kr,&
     -.47413283039555834655210340820160e-12_kr,&
     +.11221172048389864324731799928920e-12_kr,&
     -.26804225434840309912826809093395e-13_kr,&
     +.64578514417716530343580369067212e-14_kr,&
     -.15682760501666478830305702849194e-14_kr,&
     +.38367865399315404861821516441408e-15_kr,&
     -.94517173027579130478871048932556e-16_kr,&
     +.23434812288949573293896666439133e-16_kr,&
     -.58458661580214714576123194419882e-17_kr,&
     +.14666229867947778605873617419195e-17_kr,&
     -.36993923476444472706592538274474e-18_kr,&
     +.93790159936721242136014291817813e-19_kr,&
     -.23893673221937873136308224087381e-19_kr,&
     +.61150624629497608051934223837866e-20_kr,&
     -.15718585327554025507719853288106e-20_kr,&
     +.40572387285585397769519294491306e-21_kr,&
     -.10514026554738034990566367122773e-21_kr,&
     +.27349664930638667785806003131733e-22_kr,&
     -.71401604080205796099355574271999e-23_kr,&
     +.18705552432235079986756924211199e-23_kr,&
     -.49167468166870480520478020949333e-24_kr,&
     +.12964988119684031730916087125333e-24_kr,&
     -.34292515688362864461623940437333e-25_kr,&
     +.90972241643887034329104820906666e-26_kr,&
     -.24202112314316856489934847999999e-26_kr,&
     +.64563612934639510757670475093333e-27_kr,&
     -.17269132735340541122315987626666e-27_kr,&
     +.46308611659151500715194231466666e-28_kr,&
     -.12448703637214131241755170133333e-28_kr,&
     +.33544574090520678532907007999999e-29_kr,&
     -.90598868521070774437543935999999e-30_kr,&
     +.24524147051474238587273216000000e-30_kr,&
     -.66528178733552062817107967999999e-31_kr/)
   real(kr),dimension(64)::ae14cs=(/&
     -.1892918000753016825495679942820e+0_kr,&
     -.8648117855259871489968817056824e-1_kr,&
     +.7224101543746594747021514839184e-2_kr,&
     -.8097559457557386197159655610181e-3_kr,&
     +.1099913443266138867179251157002e-3_kr,&
     -.1717332998937767371495358814487e-4_kr,&
     +.2985627514479283322825342495003e-5_kr,&
     -.5659649145771930056560167267155e-6_kr,&
     +.1152680839714140019226583501663e-6_kr,&
     -.2495030440269338228842128765065e-7_kr,&
     +.5692324201833754367039370368140e-8_kr,&
     -.1359957664805600338490030939176e-8_kr,&
     +.3384662888760884590184512925859e-9_kr,&
     -.8737853904474681952350849316580e-10_kr,&
     +.2331588663222659718612613400470e-10_kr,&
     -.6411481049213785969753165196326e-11_kr,&
     +.1812246980204816433384359484682e-11_kr,&
     -.5253831761558460688819403840466e-12_kr,&
     +.1559218272591925698855028609825e-12_kr,&
     -.4729168297080398718476429369466e-13_kr,&
     +.1463761864393243502076199493808e-13_kr,&
     -.4617388988712924102232173623604e-14_kr,&
     +.1482710348289369323789239660371e-14_kr,&
     -.4841672496239229146973165734417e-15_kr,&
     +.1606215575700290408116571966188e-15_kr,&
     -.5408917538957170947895023784252e-16_kr,&
     +.1847470159346897881370231402310e-16_kr,&
     -.6395830792759094470500610425050e-17_kr,&
     +.2242780721699759457250233276170e-17_kr,&
     -.7961369173983947552744555308646e-18_kr,&
     +.2859308111540197459808619929272e-18_kr,&
     -.1038450244701137145900697137446e-18_kr,&
     +.3812040607097975780866841008319e-19_kr,&
     -.1413795417717200768717562723696e-19_kr,&
     +.5295367865182740958305442594815e-20_kr,&
     -.2002264245026825902137211131439e-20_kr,&
     +.7640262751275196014736848610918e-21_kr,&
     -.2941119006868787883311263523362e-21_kr,&
     +.1141823539078927193037691483586e-21_kr,&
     -.4469308475955298425247020718489e-22_kr,&
     +.1763262410571750770630491408520e-22_kr,&
     -.7009968187925902356351518262340e-23_kr,&
     +.2807573556558378922287757507515e-23_kr,&
     -.1132560944981086432141888891562e-23_kr,&
     +.4600574684375017946156764233727e-24_kr,&
     -.1881448598976133459864609148108e-24_kr,&
     +.7744916111507730845444328478037e-25_kr,&
     -.3208512760585368926702703826261e-25_kr,&
     +.1337445542910839760619930421384e-25_kr,&
     -.5608671881802217048894771735210e-26_kr,&
     +.2365839716528537483710069473279e-26_kr,&
     -.1003656195025305334065834526856e-26_kr,&
     +.4281490878094161131286642556927e-27_kr,&
     -.1836345261815318199691326958250e-27_kr,&
     +.7917798231349540000097468678144e-28_kr,&
     -.3431542358742220361025015775231e-28_kr,&
     +.1494705493897103237475066008917e-28_kr,&
     -.6542620279865705439739042420053e-29_kr,&
     +.2877581395199171114340487353685e-29_kr,&
     -.1271557211796024711027981200042e-29_kr,&
     +.5644615555648722522388044622506e-30_kr,&
     -.2516994994284095106080616830293e-30_kr,&
     +.1127259818927510206370368804181e-30_kr,&
     -.5069814875800460855562584719360e-31_kr/)
   real(kr),parameter::c1=.6875e0_kr
   real(kr),parameter::zero=0
   real(kr),parameter::one=1
   real(kr),parameter::two=2
   logical::first=.true.
   save ae10cs,ae11cs,ae12cs,e11cs,e12cs,ae13cs,ae14cs,&
     ntae10,ntae11,ntae12,nte11,nte12,ntae13,ntae14,xmax,first

   if (first) then
      eta=(two**(-digits(one)))/10
      ntae10=initds(ae10cs,50,eta)
      ntae11=initds(ae11cs,60,eta)
      ntae12=initds(ae12cs,41,eta)
      nte11=initds(e11cs,29,eta)
      nte12=initds(e12cs,25,eta)
      ntae13=initds(ae13cs,50,eta)
      ntae14=initds(ae14cs,64,eta)
      xmaxt=-log(tiny(one))
      xmax=xmaxt-log(xmaxt)
   endif
   first=.false.

   if (x.le.-32*one) then
      xx=64/x+1
      e1=exp(-x)/x*(1+csevl(xx,ae10cs,ntae10))
   else if (x.le.-8*one) then
      xx=(64/x+5)/3
      e1=exp(-x)/x*(1+csevl(xx,ae11cs,ntae11))
   else if (x.le.-4*one) then
      xx=16/x+3
      e1=exp(-x)/x*(1+csevl(xx,ae12cs,ntae12))
   else if (x.le.-one) then
      xx=(2*x+5)/3
      e1=-log(-x)+csevl(xx,e11cs,nte11)
   else if (x.le.one) then
      if (x.eq.zero) call error('e1','x is 0',' ')
      e1=(-log(abs(x))-c1+x)+csevl(x,e12cs,nte12)
   else if (x.le.4*one) then
      xx=(8/x-5)/3
      e1=exp(-x)/x*(1+csevl(xx,ae13cs,ntae13))
   else if (x.le.xmax) then
      xx=8/x-1
      e1=exp(-x)/x*(1+csevl(xx,ae14cs,ntae14))
   else
      !call mess('e1','x so big e1 underflows',' ')
      e1=0
   endif
   return
   end function e1

   real(kr) function gami(a,x)
   !--------------------------------------------------------------------
   ! Evaluate the incomplete gamma function.
   ! From the SLATEC library fnlib dgami.
   !--------------------------------------------------------------------
   use util ! provide error
   ! externals
   real(kr)::a,x
   ! internals
   real(kr)::factor
   real(kr)::zero=0

   if (a.le.zero) call error('gami','a must be gt zero',' ')
   if (x.lt.zero) call error('gami','x must be ge zero',' ')

   gami=0
   if (x.ne.zero) then
      factor=exp(dlngam(a)+a*log(x))
      gami=factor*dgamit(a,x)
   endif
   return
   end function gami

   real(kr) function erfc(x)
   !--------------------------------------------------------------------
   ! Compute the complementary error function.
   ! From the SLATEC library fnlib derfc.
   !--------------------------------------------------------------------
   ! externals
   real(kr)::x
   ! internals
   real(kr)::eta,sqeps,xmax,txmax,xsml,y,xx,d1mach1,d1mach3
   integer::nterf,nterfc,nterc2
   real(kr),dimension(21)::erfcs=(/&
     -.49046121234691808039984544033376e-1_kr,&
     -.14226120510371364237824741899631e+0_kr,&
     +.10035582187599795575754676712933e-1_kr,&
     -.57687646997674847650827025509167e-3_kr,&
     +.27419931252196061034422160791471e-4_kr,&
     -.11043175507344507604135381295905e-5_kr,&
     +.38488755420345036949961311498174e-7_kr,&
     -.11808582533875466969631751801581e-8_kr,&
     +.32334215826050909646402930953354e-10_kr,&
     -.79910159470045487581607374708595e-12_kr,&
     +.17990725113961455611967245486634e-13_kr,&
     -.37186354878186926382316828209493e-15_kr,&
     +.71035990037142529711689908394666e-17_kr,&
     -.12612455119155225832495424853333e-18_kr,&
     +.20916406941769294369170500266666e-20_kr,&
     -.32539731029314072982364160000000e-22_kr,&
     +.47668672097976748332373333333333e-24_kr,&
     -.65980120782851343155199999999999e-26_kr,&
     +.86550114699637626197333333333333e-28_kr,&
     -.10788925177498064213333333333333e-29_kr,&
     +.12811883993017002666666666666666e-31_kr/)
   real(kr),dimension(49)::erc2cs=(/&
     -.6960134660230950112739150826197e-1_kr,&
     -.4110133936262089348982212084666e-1_kr,&
     +.3914495866689626881561143705244e-2_kr,&
     -.4906395650548979161280935450774e-3_kr,&
     +.7157479001377036380760894141825e-4_kr,&
     -.1153071634131232833808232847912e-4_kr,&
     +.1994670590201997635052314867709e-5_kr,&
     -.3642666471599222873936118430711e-6_kr,&
     +.6944372610005012589931277214633e-7_kr,&
     -.1371220902104366019534605141210e-7_kr,&
     +.2788389661007137131963860348087e-8_kr,&
     -.5814164724331161551864791050316e-9_kr,&
     +.1238920491752753181180168817950e-9_kr,&
     -.2690639145306743432390424937889e-10_kr,&
     +.5942614350847910982444709683840e-11_kr,&
     -.1332386735758119579287754420570e-11_kr,&
     +.3028046806177132017173697243304e-12_kr,&
     -.6966648814941032588795867588954e-13_kr,&
     +.1620854541053922969812893227628e-13_kr,&
     -.3809934465250491999876913057729e-14_kr,&
     +.9040487815978831149368971012975e-15_kr,&
     -.2164006195089607347809812047003e-15_kr,&
     +.5222102233995854984607980244172e-16_kr,&
     -.1269729602364555336372415527780e-16_kr,&
     +.3109145504276197583836227412951e-17_kr,&
     -.7663762920320385524009566714811e-18_kr,&
     +.1900819251362745202536929733290e-18_kr,&
     -.4742207279069039545225655999965e-19_kr,&
     +.1189649200076528382880683078451e-19_kr,&
     -.3000035590325780256845271313066e-20_kr,&
     +.7602993453043246173019385277098e-21_kr,&
     -.1935909447606872881569811049130e-21_kr,&
     +.4951399124773337881000042386773e-22_kr,&
     -.1271807481336371879608621989888e-22_kr,&
     +.3280049600469513043315841652053e-23_kr,&
     -.8492320176822896568924792422399e-24_kr,&
     +.2206917892807560223519879987199e-24_kr,&
     -.5755617245696528498312819507199e-25_kr,&
     +.1506191533639234250354144051199e-25_kr,&
     -.3954502959018796953104285695999e-26_kr,&
     +.1041529704151500979984645051733e-26_kr,&
     -.2751487795278765079450178901333e-27_kr,&
     +.7290058205497557408997703680000e-28_kr,&
     -.1936939645915947804077501098666e-28_kr,&
     +.5160357112051487298370054826666e-29_kr,&
     -.1378419322193094099389644800000e-29_kr,&
     +.3691326793107069042251093333333e-30_kr,&
     -.9909389590624365420653226666666e-31_kr,&
     +.2666491705195388413323946666666e-31_kr/)
   real(kr),dimension(59)::erfccs=(/&
     +.715179310202924774503697709496e-1_kr,&
     -.265324343376067157558893386681e-1_kr,&
     +.171115397792085588332699194606e-2_kr,&
     -.163751663458517884163746404749e-3_kr,&
     +.198712935005520364995974806758e-4_kr,&
     -.284371241276655508750175183152e-5_kr,&
     +.460616130896313036969379968464e-6_kr,&
     -.822775302587920842057766536366e-7_kr,&
     +.159214187277090112989358340826e-7_kr,&
     -.329507136225284321486631665072e-8_kr,&
     +.722343976040055546581261153890e-9_kr,&
     -.166485581339872959344695966886e-9_kr,&
     +.401039258823766482077671768814e-10_kr,&
     -.100481621442573113272170176283e-10_kr,&
     +.260827591330033380859341009439e-11_kr,&
     -.699111056040402486557697812476e-12_kr,&
     +.192949233326170708624205749803e-12_kr,&
     -.547013118875433106490125085271e-13_kr,&
     +.158966330976269744839084032762e-13_kr,&
     -.472689398019755483920369584290e-14_kr,&
     +.143587337678498478672873997840e-14_kr,&
     -.444951056181735839417250062829e-15_kr,&
     +.140481088476823343737305537466e-15_kr,&
     -.451381838776421089625963281623e-16_kr,&
     +.147452154104513307787018713262e-16_kr,&
     -.489262140694577615436841552532e-17_kr,&
     +.164761214141064673895301522827e-17_kr,&
     -.562681717632940809299928521323e-18_kr,&
     +.194744338223207851429197867821e-18_kr,&
     -.682630564294842072956664144723e-19_kr,&
     +.242198888729864924018301125438e-19_kr,&
     -.869341413350307042563800861857e-20_kr,&
     +.315518034622808557122363401262e-20_kr,&
     -.115737232404960874261239486742e-20_kr,&
     +.428894716160565394623737097442e-21_kr,&
     -.160503074205761685005737770964e-21_kr,&
     +.606329875745380264495069923027e-22_kr,&
     -.231140425169795849098840801367e-22_kr,&
     +.888877854066188552554702955697e-23_kr,&
     -.344726057665137652230718495566e-23_kr,&
     +.134786546020696506827582774181e-23_kr,&
     -.531179407112502173645873201807e-24_kr,&
     +.210934105861978316828954734537e-24_kr,&
     -.843836558792378911598133256738e-25_kr,&
     +.339998252494520890627359576337e-25_kr,&
     -.137945238807324209002238377110e-25_kr,&
     +.563449031183325261513392634811e-26_kr,&
     -.231649043447706544823427752700e-26_kr,&
     +.958446284460181015263158381226e-27_kr,&
     -.399072288033010972624224850193e-27_kr,&
     +.167212922594447736017228709669e-27_kr,&
     -.704599152276601385638803782587e-28_kr,&
     +.297976840286420635412357989444e-28_kr,&
     -.126252246646061929722422632994e-28_kr,&
     +.539543870454248793985299653154e-29_kr,&
     -.238099288253145918675346190062e-29_kr,&
     +.109905283010276157359726683750e-29_kr,&
     -.486771374164496572732518677435e-30_kr,&
     +.152587726411035756763200828211e-30_kr/)
   real(kr),parameter::sqrtpi=1.77245385090551602729816748334115e0_kr
   real(kr),parameter::zero=0
   real(kr),parameter::one=1
   real(kr),parameter::two=2
   logical::first=.true.
   save erfcs,erc2cs,erfccs,nterf,nterfc,nterc2,xsml,xmax,sqeps,first

   if (first) then
      d1mach1=tiny(one)
      d1mach3=two**(-digits(one))
      eta=d1mach3/10
      nterf=initds(erfcs,21,eta)
      nterfc=initds(erfccs,59,eta)
      nterc2=initds(erc2cs,49,eta)
      xsml=-sqrt(-log(sqrtpi*d1mach3))
      txmax=sqrt(-log(sqrtpi*d1mach1))
      xmax=txmax-log(txmax)/(2*txmax)-one/10
      sqeps=sqrt(2*d1mach3)
   endif
   first=.false.

   if (x.le.xsml) then
      erfc=2
   else if (x.le.xmax) then
      y=abs(x)
      if (y.le.one) then
         if (y.lt.sqeps) erfc=1-2*x/sqrtpi
         if (y.ge.sqeps) erfc=1-x*(1+csevl(2*x*x-1,erfcs,nterf))
      else
         y=y*y
         if (y.le.4*one) then
            xx=(8/y-5)/3
            erfc=exp(-y)/abs(x)*(one/2+csevl(xx,erc2cs,nterc2))
         endif
         if (y.gt.4*one) then
            xx=8/y-1
            erfc=exp(-y)/abs(x)*(one/2+csevl(xx,erfccs,nterfc))
         endif
         if (x.lt.zero) erfc=2-erfc
      endif
   else
     ! call mess('derfc','x so big erfc underflows',' ')
     erfc=0
   endif
   return
   end function erfc

   subroutine dlgams(x,dlgam,sgngam)
   !--------------------------------------------------------------------
   ! Compute the logarithm of the absolute value of the gamma function.
   ! From the SLATEC library fnlib dlgams.
   !--------------------------------------------------------------------
   ! externals
   real(kr)::x,dlgam,sgngam
   ! internals
   integer::intx
   real(kr),parameter::zero=0
   real(kr),parameter::two=2
   real(kr),parameter::tenth=0.1e0_kr

   dlgam=dlngam(x)
   sgngam=1
   if (x.gt.zero) return
   intx=int(mod(-aint(x),two)+tenth)
   if (intx.eq.0) sgngam=-1
   return
   end subroutine dlgams

   real(kr) function dlngam(x)
   !--------------------------------------------------------------------
   ! Compute the logarithm of the absolute value of the gamma function.
   ! From the SLATEC library fnlib dlngam.
   !--------------------------------------------------------------------
   use util ! provides error
   ! externals
   real(kr)::x
   ! internals
   real(kr)::dxrel,sinpiy,xmax,y,z,temp
   real(kr),parameter::sq2pil=0.91893853320467274178032973640562e0_kr
   real(kr),parameter::sqpi2l=0.225791352644727432363097614947441e0_kr
   real(kr),parameter::pi=3.14159265358979323846264338327950e0_kr
   real(kr),parameter::zero=0
   real(kr),parameter::one=1
   real(kr),parameter::two=2
   logical::first=.true.
   save xmax,dxrel,first

   if (first) then
      temp=1/log(huge(one))
      xmax=temp*huge(one)
      dxrel=sqrt(two**(1-digits(one)))
   endif
   first=.false.

   y=abs(x)
   z=(2*x-1)/2
   if (y.le.10*one) then
      dlngam=log(abs(dgamma(x)))
   else
      if (y.gt.xmax) call error('dlngam',&
        'abs(x) so big dlngam overflows',' ')
      if (x.gt.zero) then
         dlngam=sq2pil+z*log(x)-x+d9lgmc(y)
      else
         sinpiy=abs(sin(pi*y))
         if (sinpiy.eq.zero) call error('dlngam',&
           'x is a negative integer',' ')
         if (abs((x-aint(z))/x).lt.dxrel) call mess('dlngam',&
           'answer lt half precision because x too near',&
           'negative integer')
         dlngam=sqpi2l+z*log(y)-x-log(sinpiy)-d9lgmc(y)
      endif
   endif
   return
   end function dlngam

   real(kr) function csevl(x,cs,n)
   !--------------------------------------------------------------------
   ! Evaluate a Chebyshev series.
   ! From the SLATEC library fnlib dcsevl.
   !--------------------------------------------------------------------
   use util ! provides error
   ! externals
   real(kr)::x
   real(kr)::cs(*)
   integer::n
   ! internals
   real(kr)::b0,b1,b2,onepl,twox
   integer::i,ni
   real(kr),parameter::one=1
   real(kr),parameter::two=2
   logical::first=.true.
   save first,onepl

   if (first) onepl=1+two**(1-digits(one))
   first=.false.
   if (n.lt.1) call error('csevl','number of terms .le. 0',' ')
   if (n.gt.1000) call error('csevl',&
     'number of terms .gt. 1000',' ')
   if (abs(x).gt.onepl) call error('csevl',&
     'x outside the interval (-1,+1)',' ')

   b1=0
   b0=0
   twox=2*x
   do i=1,n
      b2=b1
      b1=b0
      ni=n+1-i
      b0=twox*b1-b2+cs(ni)
   enddo
   csevl=(b0-b2)/2
   return
   end function csevl

   real(kr) function d9lgit(a,x,algap1)
   !--------------------------------------------------------------------
   ! Subsidiary routine.
   ! Compute the logarithm of Tricomi's incomplete gamma function with
   ! Perron's continued fraction for large x and a .ge. x.
   ! From the SLATEC library fnlib d9lgit.
   !--------------------------------------------------------------------
   use util ! provides error,mess
   ! externals
   real(kr)::a,x,algap1
   ! internals
   real(kr)::ax,a1x,eps,fk,hstar,p,r,s,sqeps,t
   integer::k
   real(kr),parameter::zero=0
   real(kr),parameter::one=1
   real(kr),parameter::two=2
   logical::first=.true.
   save eps,sqeps,first

   if (first) then
      eps=two**(-digits(one))/2
      sqeps=sqrt(two**(1-digits(one)))
   endif
   first=.false.

   if (x.le.zero.or.a.lt.x) call error('d9lgit',&
     'x should be gt 0.0 and le a',' ')
   ax=a+x
   a1x=ax+1
   r=0
   p=1
   s=p
   k=0
   do while (abs(p).ge.eps*s)
      k=k+1
      if (k.gt.200) then
         call error('d9lgit',&
           'no convergence in 200 terms of continued fraction',' ')
      endif
      fk=k
      t=(a+fk)*x*(1+r)
      r=t/((ax+fk)*(a1x+fk)-t)
      p=r*p
      s=s+p
   enddo
   hstar=1-x*s/a1x
   if (hstar.lt.sqeps) call mess('d9lgit',&
     'result less than half precision',' ')
   d9lgit=-x-algap1-log(hstar)
   return
   end function d9lgit

   real(kr) function d9lgmc(x)
   !--------------------------------------------------------------------
   ! Subsidiary routine.
   ! Compute the log gamma correction factor so that
   ! log(dgamma(x)) = log(sqrt(2*pi)) + (x-5.)*log(x) - x + d9lgmc(x).
   ! From the SLATEC library fnlib d9lgmc.
   !--------------------------------------------------------------------
   use util ! provides error
   ! externals
   real(kr)::x
   ! internals
   real(kr)::eta,xbig,xmax,xx
   integer::nalgm
   real(kr),dimension(15)::algmcs=(/&
     +.1666389480451863247205729650822e+0_kr,&
     -.1384948176067563840732986059135e-4_kr,&
     +.9810825646924729426157171547487e-8_kr,&
     -.1809129475572494194263306266719e-10_kr,&
     +.6221098041892605227126015543416e-13_kr,&
     -.3399615005417721944303330599666e-15_kr,&
     +.2683181998482698748957538846666e-17_kr,&
     -.2868042435334643284144622399999e-19_kr,&
     +.3962837061046434803679306666666e-21_kr,&
     -.6831888753985766870111999999999e-23_kr,&
     +.1429227355942498147573333333333e-24_kr,&
     -.3547598158101070547199999999999e-26_kr,&
     +.1025680058010470912000000000000e-27_kr,&
     -.3401102254316748799999999999999e-29_kr,&
     +.1276642195630062933333333333333e-30_kr/)
   real(kr),parameter::one=1
   real(kr),parameter::two=2
   logical::first=.true.
   save algmcs,nalgm,xbig,xmax,first

   if (first) then
      eta=two**(-digits(one))
      nalgm=initds(algmcs,15,eta)
      xbig=1/sqrt(two**(1-digits(one)))
      xmax=exp(min(log(huge(one)/12),-log(12*tiny(one))))
   endif
   first=.false.

   if (x.lt.10*one) call error('d9lgmc','x must be ge 10',' ')
   if (x.lt.xmax) then
      d9lgmc=1/(12*x)
      if (x.lt.xbig) then
         xx=2*(10/x)**2-1
         d9lgmc=csevl(xx,algmcs,nalgm)/x
      endif
   else
      d9lgmc=0
      !call error('d9lgmc','x so big d9lgmc underflows',' ')
   endif
   return
   end function d9lgmc

   real(kr) function dgamit(a,x)
   !--------------------------------------------------------------------
   ! Calculate Tricomi's form of the incomplete gamma function.
   ! From the SLATEC library fnlib dgamit.
   !--------------------------------------------------------------------
   use util ! provides error,mess
   ! externals
   real(kr)::a,x
   ! internals
   real(kr)::aeps,ainta,algap1,alneps,alng,alx,&
     h,sga,sgngam,sqeps,t,y
   real(kr),parameter::zero=0
   real(kr),parameter::one=1
   real(kr),parameter::two=2
   logical::first=.true.
   save alneps,sqeps,first

   if (first) then
      alneps=-log(two**(-digits(one)))
      sqeps=sqrt(two**(1-digits(one)))
   endif
   first=.false.

   if (x.lt.zero) call error('dgamit','x is negative',' ')

   if (x.ne.zero) alx=log(x)
   sga=1
   if (a.ne.zero) sga=sign(one,a)
   ainta=aint(a+sga/2)
   aeps=a-ainta

   if (x.le.zero) then
      dgamit=0
      if (ainta.gt.zero.or.aeps.ne.zero) dgamit=dgamr(a+1)

   else if (x.le.one) then
      if (a.ge.-one/2.or.aeps.ne.zero) then
         call dlgams(a+1,algap1,sgngam)
      endif
      dgamit=d9gmit(a,x,algap1,sgngam,alx)

   else if (a.ge.x) then
      y=dlngam(a+1)
      t=d9lgit(a,x,y)
      dgamit=exp(t)

   else
      alng=d9lgic(a,x,alx)
      ! evaluate dgamit in terms of log (dgamic (a, x))
      h=1
      if (aeps.eq.zero.and.ainta.le.zero) then
         t=-a*alx+log(abs(h))
         dgamit=sign(exp(t),h)
      else
         call dlgams(a+1,algap1,sgngam)
         t=log(abs(a))+alng-algap1
         if (t.gt.alneps) then
            t=t-a*alx
            dgamit=-sga*sgngam*exp(t)
         else
            if (t.gt.(-alneps)) h=1-sga*sgngam*exp(t)
            if (abs(h).le.sqeps) then
               call mess('dgamit','result lt half precision',' ')
            endif
            t=-a*alx+log(abs(h))
            dgamit=sign(exp(t),h)
         endif
      endif
   endif
   return
   end function dgamit

   subroutine dgamlm(xmin,xmax)
   !--------------------------------------------------------------------
   ! Compute the minimum and maximum bounds for the argument in
   ! the gamma function.
   ! From the SLATEC library fnlib dgamlm.
   !--------------------------------------------------------------------
   use util ! provides error
   ! externals
   real(kr)::xmin,xmax
   ! internals
   real(kr)::alnbig,alnsml,xln,xold
   integer::i
   real(kr),parameter::one=1
   real(kr),parameter::c1=.2258e0_kr
   real(kr),parameter::c2=.9189e0_kr

   xold=0
   alnsml=log(tiny(one))
   xmin=-alnsml
   i=0
   do while (abs(xmin-xold).ge.one/200)
      i=i+1
      if (i.gt.10) then
         call error('dgamlm','unable to find xmin',' ')
      endif
      xold=xmin
      xln=log(xmin)
      xmin=xmin-xmin*((xmin+one/2)*xln-xmin-c1+alnsml)/(xmin*xln+one/2)
   enddo
   xmin=-xmin+one/100

   alnbig=log(huge(one))
   xmax=alnbig
   i=0
   do while (abs(xmax-xold).ge.one/200)
      i=i+1
      if (i.gt.10) then
         call error('dgamlm','unable to find xmax',' ')
      endif
      xold=xmax
      xln=log(xmax)
      xmax=xmax-xmax*((xmax-one/2)*xln-xmax+c2-alnbig)/(xmax*xln-one/2)
   enddo
   xmax=xmax-one/100
   xmin=max(xmin,-xmax+1)
   return
   end subroutine dgamlm

   real(kr) function dgamma(x)
   !--------------------------------------------------------------------
   ! Compute the complete gamma function.
   ! From the SLATEC library fnlib dgamma.
   !--------------------------------------------------------------------
   use util ! provide error
   ! externals
   real(kr)::x
   ! internals
   real(kr)::eta,dxrel,sinpiy,xmax,xmin,y,xx
   integer::i,n,ngam
   real(kr),dimension(42)::gamcs=(/&
     +.8571195590989331421920062399942e-2_kr,&
     +.4415381324841006757191315771652e-2_kr,&
     +.5685043681599363378632664588789e-1_kr,&
     -.4219835396418560501012500186624e-2_kr,&
     +.1326808181212460220584006796352e-2_kr,&
     -.1893024529798880432523947023886e-3_kr,&
     +.3606925327441245256578082217225e-4_kr,&
     -.6056761904460864218485548290365e-5_kr,&
     +.1055829546302283344731823509093e-5_kr,&
     -.1811967365542384048291855891166e-6_kr,&
     +.3117724964715322277790254593169e-7_kr,&
     -.5354219639019687140874081024347e-8_kr,&
     +.9193275519859588946887786825940e-9_kr,&
     -.1577941280288339761767423273953e-9_kr,&
     +.2707980622934954543266540433089e-10_kr,&
     -.4646818653825730144081661058933e-11_kr,&
     +.7973350192007419656460767175359e-12_kr,&
     -.1368078209830916025799499172309e-12_kr,&
     +.2347319486563800657233471771688e-13_kr,&
     -.4027432614949066932766570534699e-14_kr,&
     +.6910051747372100912138336975257e-15_kr,&
     -.1185584500221992907052387126192e-15_kr,&
     +.2034148542496373955201026051932e-16_kr,&
     -.3490054341717405849274012949108e-17_kr,&
     +.5987993856485305567135051066026e-18_kr,&
     -.1027378057872228074490069778431e-18_kr,&
     +.1762702816060529824942759660748e-19_kr,&
     -.3024320653735306260958772112042e-20_kr,&
     +.5188914660218397839717833550506e-21_kr,&
     -.8902770842456576692449251601066e-22_kr,&
     +.1527474068493342602274596891306e-22_kr,&
     -.2620731256187362900257328332799e-23_kr,&
     +.4496464047830538670331046570666e-24_kr,&
     -.7714712731336877911703901525333e-25_kr,&
     +.1323635453126044036486572714666e-25_kr,&
     -.2270999412942928816702313813333e-26_kr,&
     +.3896418998003991449320816639999e-27_kr,&
     -.6685198115125953327792127999999e-28_kr,&
     +.1146998663140024384347613866666e-28_kr,&
     -.1967938586345134677295103999999e-29_kr,&
     +.3376448816585338090334890666666e-30_kr,&
     -.5793070335782135784625493333333e-31_kr/)
   real(kr),parameter::pi=3.14159265358979323846264338327950e0_kr
   real(kr),parameter::sq2pil=0.91893853320467274178032973640562e0_kr
   real(kr),parameter::zero=0
   real(kr),parameter::one=1
   real(kr),parameter::two=2
   real(kr),parameter::c1=.9375e0_kr
   logical::first=.true.
   save gamcs,ngam,xmin,xmax,dxrel,first

   if (first) then
      eta=two**(-digits(one))/10
      ngam=initds(gamcs,42,eta)
      call dgamlm(xmin,xmax)
      dxrel=sqrt(two**(1-digits(one)))
   endif
   first=.false.

   y=abs(x)
   if (y.le.10*one) then
      ! compute gamma(x) for -xbnd .le. x .le. xbnd.  reduce interval
      !  and find gamma(1+y) for 0.0 .le. y .lt. 1.0 first of all.
      n=int(x)
      if (x.lt.zero) n=n-1
      y=x-n
      n=n-1
      xx=2*y-1
      dgamma=c1+csevl(xx,gamcs,ngam)

      if (n.lt.0) then
         n=-n
         if (x.eq.zero) call error('dgamma','x is 0',' ')
         if (x.lt.zero.and.x+n-2.eq.zero) call error('dgamma',&
           'x is a negative integer',' ')
         if (x.lt.-one/2.and.abs((x-aint(x-one/2))/x).lt.dxrel)&
           call mess('dgamma',&
             'answer lt half precision because x too near',&
             ' negative integer')
         do i=1,n
           dgamma=dgamma/(x+i-1)
         enddo
      else if (n.gt.0) then
         do i=1,n
           dgamma=(y+i)*dgamma
         enddo
      endif

   else
      ! gamma(x) for abs(x) .gt. 10.0.  recall y = abs(x).
      if (x.gt.xmax) call error('dgamma',&
        'x so big gamma overflows',' ')
      dgamma=0
      ! if (x.lt.xmin) call mess('dgamma',&
      !   'x so small gamma underflows',' ')
      if (x.ge.xmin) then
         dgamma=exp((y-one/2)*log(y)-y+sq2pil+d9lgmc(y))
         if (x.le.zero) then
            if (abs((x-aint(x-one/2))/x).lt.dxrel) then
               call mess('dgamma',&
                 'answer lt half precision, x too near',&
                 ' negative integer')
            endif
            sinpiy=sin(pi*y)
            if (sinpiy.eq.zero) call error('dgamma',&
              'x is a negative integer',' ')
            dgamma=-pi/(y*sinpiy*dgamma)
         endif
      endif
   endif

   return
   end function dgamma

   real(kr) function dgamr(x)
   !--------------------------------------------------------------------
   ! Compute the reciprocal of the gamma function.
   ! From the SLATEC library fnlib dgamr.
   !--------------------------------------------------------------------
   ! externals
   real(kr)::x
   ! internals
   real(kr)::alngx,sgngx
   real(kr),parameter::zero=0
   real(kr),parameter::one=1

   dgamr=0
   if (x.le.zero.and.aint(x).eq.x) return
   if (abs(x).le.10*one) then
      dgamr=1/dgamma(x)
   else
      call dlgams(x,alngx,sgngx)
      dgamr=sgngx*exp(-alngx)
   endif
   return
   end function dgamr

   integer function initds(os,nos,eta)
   !--------------------------------------------------------------------
   ! Determine the number of terms needed in an orthogonal
   ! polynomial series so that it meets a specified accuracy.
   ! From the SLATEC library fnlib initds.
   !--------------------------------------------------------------------
   use util ! provide mess
   ! externals
   real(kr)::os(*)
   integer::nos
   real(kr)::eta
   ! internals
   integer::i,ii
   real(kr)::err

   if (nos.lt.1) call mess('initds',&
     'number of coefficients is less than 1',' ')

   err=0.
   ii=0
   do while (err.le.eta.and.ii.lt.nos)
      ii=ii+1
      i=nos+1-ii
      err=err+abs(real(os(i)))
   enddo
   if (i.eq.nos) call mess('initds',&
     'chebyshev series too short for specified accuracy',' ')
   initds=i
   return
   end function initds

   real(kr) function d9gmit(a,x,algap1,sgngam,alx)
   !--------------------------------------------------------------------
   ! Subsidiary routine.
   ! Compute Tricomi's incomplete gamma function for small arguments.
   ! From the SLATEC library fnlib d9gmit.
   !--------------------------------------------------------------------
   use util ! provides error
   ! externals
   real(kr)::a,x,algap1,sgngam,alx
   ! internals
   real(kr)::ae,aeps,algs,alg2,bot,eps,fk,s,sgng2,t,te
   integer::k,m,ma
   real(kr),parameter::zero=0
   real(kr),parameter::one=1
   real(kr),parameter::two=2
   logical::first=.true.
   save eps,bot,first

   if (first) then
      eps=two**(-digits(one))/2
      bot=log(tiny(one))
   endif
   first=.false.

   if (x.le.zero) call error('d9gmit','x should be gt 0',' ')

   ma=int(a+one/2)
   if (a.lt.zero) ma=int(a-one/2)
   aeps=a-ma

   ae=a
   if (a.lt.-one/2) ae=aeps

   t=1
   te=ae
   s=t
   k=0
   do while (abs(t).ge.eps*abs(s))
      k=k+1
      if (k.gt.200) then
         call error('d9gmit',&
           'no convergence in 200 terms of taylor-s series',' ')
      endif
      fk=k
      te=-x*te/fk
      t=te/(ae+fk)
      s=s+t
   enddo

   if (a.ge.-one/2) then
      algs=-algap1+log(s)
      d9gmit=exp(algs)
   else
      algs=-dlngam(1+aeps)+log(s)
      s=1
      m=-ma-1
      if (m.ne.0) then
         t=1
         k=0
         do while (abs(t).ge.eps*abs(s).and.k.lt.m)
            k=k+1
            t=x*t/(aeps-(m+1-k))
            s=s+t
         enddo
      endif
      d9gmit=0
      algs=-ma*log(x)+algs
      if (s.eq.zero.or.aeps.eq.zero) then
         d9gmit=exp(algs)
      else
         sgng2=sgngam*sign(one,s)
         alg2=-x-algap1+log(abs(s))
         if (alg2.gt.bot) d9gmit=sgng2*exp(alg2)
         if (algs.gt.bot) d9gmit=d9gmit+exp(algs)
      endif
   endif
   return
   end function d9gmit

   real(kr) function d9lgic(a,x,alx)
   !--------------------------------------------------------------------
   ! Subsidiary routine.
   ! Compute the log complementary incomplete gamma function
   ! for large x and for a .le. x.
   ! From the SLATEC library fnlib d9lgic.
   !--------------------------------------------------------------------
   use util ! provides error
   ! externals
   real(kr)::a,x,alx
   ! internals
   integer::k
   real(kr)::fk,p,r,s,t,xma,xpa
   real(kr),parameter::zero=0
   real(kr),parameter::one=1
   real(kr),parameter::two=2
   real(kr)::eps=0

   if (eps.eq.zero) eps=two**(-digits(one))/2
   xpa=x+1-a
   xma=x-1-a
   r=0
   p=1
   s=p
   k=0
   do while (abs(p).ge.eps*s)
      k=k+1
      if (k.gt.300) then
         call error('d9lgic',&
           'no convergence in 300 terms of continued fraction',' ')
      endif
      fk=k
      t=fk*(a-fk)*(1+r)
      r=-t/((xma+2*fk)*(xpa+2*fk)+t)
      p=r*p
      s=s+p
   enddo
   d9lgic=a*alx-x+log(s/xpa)
   return
   end function d9lgic

end module mathm

